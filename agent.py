"""\nAgente principal usando Microsoft Agent Framework con OpenAI API.\nIntegra herramientas generales + SIIGO Nube ERP (CRUD completo).\n"""\nimport os\nfrom typing import Annotated\nfrom agent_framework import ChatAgent\nfrom agent_framework.openai import OpenAIChatClient\nfrom siigo_tools import SIIGO_TOOLS\n\n\n# ==================== HERRAMIENTAS GENERALES ====================\n\ndef get_weather(\n    location: Annotated[str, "La ubicación para obtener el clima."],\n) -> str:\n    """Obtiene el clima para una ubicación dada."""\n    import random\n    conditions = ["soleado", "nublado", "lluvioso", "tormentoso"]\n    return f"El clima en {location} es {conditions[random.randint(0, 3)]} con una temperatura máxima de {random.randint(15, 35)}°C."\n\n\ndef search_web(\n    query: Annotated[str, "La consulta de búsqueda."],\n) -> str:\n    """Busca información en la web (simulado)."""\n    return f"Resultados de búsqueda para '{query}': Se encontraron varios artículos relevantes sobre el tema."\n\n\ndef calculate(\n    expression: Annotated[str, "La expresión matemática a calcular."],\n) -> str:\n    """Calcula una expresión matemática."""\n    try:\n        # Evaluación segura de expresiones matemáticas\n        allowed_chars = set("0123456789+-*/().% ")\n        if all(c in allowed_chars for c in expression):\n            result = eval(expression)\n            return f"El resultado de {expression} es: {result}"\n        else:\n            return "Error: Expresión no válida. Solo se permiten operaciones matemáticas básicas."\n    except Exception as e:\n        return f"Error al calcular: {str(e)}"\n\n\ndef get_current_time() -> str:\n    """Obtiene la fecha y hora actual."""\n    from datetime import datetime\n    now = datetime.now()\n    return f"La fecha y hora actual es: {now.strftime('%d/%m/%Y %H:%M:%S')}"\n\n\n# ==================== TODAS LAS HERRAMIENTAS ====================\n\nGENERAL_TOOLS = [\n    get_weather,\n    search_web,\n    calculate,\n    get_current_time,\n]\n\nALL_TOOLS = GENERAL_TOOLS + SIIGO_TOOLS\n\n\nasync def create_agent() -> ChatAgent:\n    """Crea y retorna el agente configurado."""\n    \n    # Configuración de OpenAI API\n    openai_api_key = os.getenv("OPENAI_API_KEY")\n    model_id = os.getenv("MODEL_ID", "gpt-4o-mini")\n    \n    if not openai_api_key:\n        raise ValueError("OPENAI_API_KEY no está configurado. Necesitas tu API Key de OpenAI.")\n    \n    # Cliente OpenAI usando Agent Framework\n    client = OpenAIChatClient(\n        api_key=openai_api_key,\n        model_id=model_id,\n    )\n    \n    # Crear el agente con ChatAgent\n    agent = ChatAgent(\n        name="AsistenteMAF",\n        instructions="""Eres un asistente inteligente y experto en gestión empresarial, desplegado en producción.\nEres el asistente principal del sistema MAF, con acceso completo al ERP Siigo Nube.\n\n## Capacidades Generales\n- Consultar el clima de cualquier ubicación\n- Buscar información en la web\n- Realizar cálculos matemáticos\n- Dar la fecha y hora actual\n\n## Capacidades SIIGO Nube (ERP)\nTienes acceso CRUD completo a los siguientes módulos del ERP Siigo Nube:\n\n1. **Catálogos**: Consultar impuestos, bodegas, usuarios, formas de pago, centros de costo, cuentas contables, etc.\n2. **Clientes**: Crear, consultar, listar y editar clientes/terceros (no se pueden eliminar).\n3. **Productos**: CRUD completo de productos y servicios.\n4. **Facturas de Venta**: CRUD completo + facturación electrónica DIAN (crear, PDF, XML, enviar email).\n5. **Facturas de Compra**: CRUD completo de facturas de compra/gasto.\n6. **Notas Crédito**: Crear y consultar (no se pueden editar ni eliminar).\n7. **Cotizaciones**: CRUD completo de cotizaciones/ofertas comerciales.\n8. **Recibos de Caja**: Crear y consultar ingresos/recibos de caja.\n9. **Recibos de Pago**: Crear, consultar y eliminar pagos a proveedores.\n10. **Comprobantes Contables**: Crear y consultar comprobantes de contabilidad.\n11. **Cuentas por Pagar**: Consultar reportes de cuentas por pagar (vencidas, por proveedor, resumen).\n12. **Categorías de Inventario**: Crear, consultar y editar clasificaciones de inventario.\n\n## Instrucciones Importantes\n- Responde siempre en español de manera clara y profesional.\n- Cuando el usuario pida una operación en Siigo, usa la herramienta correspondiente.\n- Para crear registros (facturas, clientes, etc.), primero pregunta los datos necesarios si no los proporciona.\n- Siempre confirma las operaciones destructivas (eliminar, anular) antes de ejecutarlas.\n- Si una operación falla, explica el error y sugiere cómo solucionarlo.\n- Para listar registros grandes, usa paginación (page, page_size).\n- Los parámetros JSON que envíes a las herramientas SIIGO deben ser un string JSON válido.""",\n        chat_client=client,\n        tools=ALL_TOOLS,\n    )\n    \n    return agent\n