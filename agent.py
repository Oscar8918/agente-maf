"""\nAgente principal usando Microsoft Agent Framework con OpenAI API.\nDelega operaciones de Siigo Nube al sub-agente SIIGO especializado.\n"""\nimport os\nimport asyncio\nfrom typing import Annotated\nfrom agent_framework import ChatAgent\nfrom agent_framework.openai import OpenAIChatClient\nfrom siigo_agent import run_siigo_agent\n\n\n# ==================== HERRAMIENTAS GENERALES ====================\n\ndef get_weather(\n    location: Annotated[str, "La ubicaci\u00f3n para obtener el clima."],\n) -> str:\n    """Obtiene el clima para una ubicaci\u00f3n dada."""\n    import random\n    conditions = ["soleado", "nublado", "lluvioso", "tormentoso"]\n    return f"El clima en {location} es {conditions[random.randint(0, 3)]} con una temperatura m\u00e1xima de {random.randint(15, 35)}\u00b0C."\n\n\ndef search_web(\n    query: Annotated[str, "La consulta de b\u00fasqueda."],\n) -> str:\n    """Busca informaci\u00f3n en la web (simulado)."""\n    return f"Resultados de b\u00fasqueda para '{query}': Se encontraron varios art\u00edculos relevantes sobre el tema."\n\n\ndef calculate(\n    expression: Annotated[str, "La expresi\u00f3n matem\u00e1tica a calcular."],\n) -> str:\n    """Calcula una expresi\u00f3n matem\u00e1tica."""\n    try:\n        # Evaluaci\u00f3n segura de expresiones matem\u00e1ticas\n        allowed_chars = set("0123456789+-*/().% ")\n        if all(c in allowed_chars for c in expression):\n            result = eval(expression)\n            return f"El resultado de {expression} es: {result}"\n        else:\n            return "Error: Expresi\u00f3n no v\u00e1lida. Solo se permiten operaciones matem\u00e1ticas b\u00e1sicas."\n    except Exception as e:\n        return f"Error al calcular: {str(e)}"\n\n\ndef get_current_time() -> str:\n    """Obtiene la fecha y hora actual."""\n    from datetime import datetime\n    now = datetime.now()\n    return f"La fecha y hora actual es: {now.strftime('%d/%m/%Y %H:%M:%S')}"\n\n\n# ==================== TOOL DEL SUB-AGENTE SIIGO ====================\n\nasync def consultar_siigo_erp(\n    consulta: Annotated[str, "Descripci\u00f3n detallada de lo que se necesita hacer en Siigo Nube. Incluir toda la informaci\u00f3n relevante: m\u00f3dulo (clientes, productos, facturas, etc.), operaci\u00f3n (listar, crear, editar, consultar, eliminar), y datos necesarios (IDs, nombres, filtros, campos del registro, etc.)."],\n) -> str:\n    """Delega al sub-agente especializado en Siigo Nube ERP. Usa esta herramienta para CUALQUIER operaci\u00f3n con Siigo: gestionar clientes, productos, facturas de venta/compra, notas cr\u00e9dito, cotizaciones, recibos de caja/pago, comprobantes contables, cuentas por pagar, categor\u00edas de inventario, y consultar cat\u00e1logos (impuestos, bodegas, formas de pago, etc.)."""\n    return await run_siigo_agent(consulta)\n\n\n# ==================== TODAS LAS HERRAMIENTAS ====================\n\nGENERAL_TOOLS = [\n    get_weather,\n    search_web,\n    calculate,\n    get_current_time,\n]\n\nALL_TOOLS = GENERAL_TOOLS + [consultar_siigo_erp]\n\n\nasync def create_agent() -> ChatAgent:\n    """Crea y retorna el agente configurado."""\n    \n    # Configuraci\u00f3n de OpenAI API\n    openai_api_key = os.getenv("OPENAI_API_KEY")\n    model_id = os.getenv("MODEL_ID", "gpt-4o-mini")\n    \n    if not openai_api_key:\n        raise ValueError("OPENAI_API_KEY no est\u00e1 configurado. Necesitas tu API Key de OpenAI.")\n    \n    # Cliente OpenAI usando Agent Framework\n    client = OpenAIChatClient(\n        api_key=openai_api_key,\n        model_id=model_id,\n    )\n    \n    # Crear el agente con ChatAgent\n    agent = ChatAgent(\n        name="AsistenteMAF",\n        instructions="""Eres un asistente inteligente y experto en gesti\u00f3n empresarial, desplegado en producci\u00f3n.\nEres el asistente principal del sistema MAF.\n\n## Capacidades Generales\n- Consultar el clima de cualquier ubicaci\u00f3n\n- Buscar informaci\u00f3n en la web\n- Realizar c\u00e1lculos matem\u00e1ticos\n- Dar la fecha y hora actual\n\n## Sub-Agente SIIGO Nube (ERP)\nTienes un sub-agente especializado en el ERP Siigo Nube. Cuando el usuario necesite cualquier operaci\u00f3n con Siigo, \nusa la herramienta `consultar_siigo_erp` y describe claramente lo que se necesita. El sub-agente maneja:\n\n- Cat\u00e1logos (impuestos, bodegas, formas de pago, cuentas contables, etc.)\n- Clientes/Terceros (crear, consultar, editar)\n- Productos y servicios (CRUD completo)\n- Facturas de venta (CRUD + facturaci\u00f3n electr\u00f3nica DIAN)\n- Facturas de compra\n- Notas cr\u00e9dito\n- Cotizaciones\n- Recibos de caja y de pago\n- Comprobantes contables\n- Cuentas por pagar (reportes)\n- Categor\u00edas de inventario\n\n## Instrucciones Importantes\n- Responde siempre en espa\u00f1ol de manera clara y profesional.\n- Para operaciones de Siigo, pasa toda la informaci\u00f3n relevante al sub-agente en la consulta.\n- Para crear registros, primero pregunta los datos necesarios si no los proporciona el usuario.\n- Confirma las operaciones destructivas (eliminar, anular) antes de delegarlas.\n- Si el sub-agente reporta un error, expl\u00edcalo al usuario y sugiere c\u00f3mo solucionarlo.""",\n        chat_client=client,\n        tools=ALL_TOOLS,\n    )\n    \n    return agent\n