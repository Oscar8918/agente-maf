"""\nServidor HTTP principal del Agente MAF.\nListo para producci\u00f3n en EasyPanel/Docker.\n"""\nimport os\nimport asyncio\nfrom contextlib import asynccontextmanager\nfrom dotenv import load_dotenv\nfrom fastapi import FastAPI, HTTPException\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom pydantic import BaseModel\nfrom typing import Optional\nimport uvicorn\n\n# Cargar variables de entorno (override=True para producci\u00f3n)\nload_dotenv(override=True)\n\nfrom agent import create_agent\nfrom siigo_agent import reset_siigo_agent\n\n# Variables globales\nagent = None\nthreads = {}\n\n\n@asynccontextmanager\nasync def lifespan(app: FastAPI):\n    """Inicializa el agente al arrancar y limpia al cerrar."""\n    global agent\n    try:\n        agent = await create_agent()\n        print("\u2705 Agente principal inicializado correctamente")\n        print("\u2705 Sub-agente SIIGO listo (se inicializa en primera consulta)")\n    except Exception as e:\n        print(f"\u26a0\ufe0f Error al inicializar agente: {e}")\n        print("El servidor seguir\u00e1 funcionando, pero /chat dar\u00e1 error hasta configurar OPENAI_API_KEY")\n    yield\n    # Cleanup\n    agent = None\n    threads.clear()\n    reset_siigo_agent()\n\n\n# FastAPI app\napp = FastAPI(\n    title="Agente MAF API",\n    description="API del Agente Inteligente con Microsoft Agent Framework",\n    version="1.0.0",\n    lifespan=lifespan,\n)\n\n# CORS para permitir requests desde cualquier origen\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=["*"],\n    allow_credentials=True,\n    allow_methods=["*"],\n    allow_headers=["*"],\n)\n\n# Modelos de datos\nclass ChatRequest(BaseModel):\n    message: str\n    thread_id: Optional[str] = None\n\nclass ChatResponse(BaseModel):\n    response: str\n    thread_id: str\n\nclass HealthResponse(BaseModel):\n    status: str\n    version: str\n\n\n@app.get("/", response_model=HealthResponse)\nasync def root():\n    """Endpoint de salud del servicio."""\n    return HealthResponse(\n        status="healthy",\n        version="1.0.0"\n    )\n\n\n@app.get("/health", response_model=HealthResponse)\nasync def health_check():\n    """Health check para EasyPanel/Docker."""\n    return HealthResponse(\n        status="healthy" if agent else "degraded",\n        version="1.0.0"\n    )\n\n\n@app.post("/chat", response_model=ChatResponse)\nasync def chat(request: ChatRequest):\n    """Endpoint principal para chatear con el agente."""\n    global agent, threads\n    \n    if agent is None:\n        raise HTTPException(\n            status_code=503,\n            detail="Agente no disponible. Verifica que OPENAI_API_KEY est\u00e9 configurado."\n        )\n    \n    try:\n        # Obtener o crear thread\n        thread_id = request.thread_id or str(id(request))\n        \n        if thread_id not in threads:\n            threads[thread_id] = agent.get_new_thread()\n        \n        thread = threads[thread_id]\n        \n        # Ejecutar el agente con streaming\n        response_text = ""\n        async for chunk in agent.run_stream(request.message, thread=thread):\n            if chunk.text:\n                response_text += chunk.text\n        \n        return ChatResponse(\n            response=response_text,\n            thread_id=thread_id\n        )\n        \n    except Exception as e:\n        raise HTTPException(\n            status_code=500,\n            detail=f"Error al procesar mensaje: {str(e)}"\n        )\n\n\n@app.delete("/threads/{thread_id}")\nasync def delete_thread(thread_id: str):\n    """Elimina un thread de conversaci\u00f3n."""\n    global threads\n    if thread_id in threads:\n        del threads[thread_id]\n        return {"message": f"Thread {thread_id} eliminado"}\n    raise HTTPException(status_code=404, detail="Thread no encontrado")\n\n\nif __name__ == "__main__":\n    port = int(os.getenv("PORT", 8000))\n    host = os.getenv("HOST", "0.0.0.0")\n    \n    print(f"\ud83d\ude80 Iniciando servidor en {host}:{port}")\n    uvicorn.run(\n        "main:app",\n        host=host,\n        port=port,\n        reload=os.getenv("DEBUG", "false").lower() == "true"\n    )\n