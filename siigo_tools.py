"""\nHerramientas SIIGO para el Agente MAF.\nConecta con las Azure Functions de SIIGO CRUD para gestionar el ERP Siigo Nube.\n\nCada función es una tool que el agente puede invocar para operaciones CRUD\nsobre los diferentes módulos de Siigo (clientes, productos, facturas, etc.).\n"""\nimport os\nimport json\nimport requests\nfrom typing import Annotated\n\n\n# ==================== CONFIGURACIÓN ====================\n\nSIIGO_BASE_URL = os.getenv("SIIGO_AZURE_FUNCTIONS_URL", "https://siigocrud.azurewebsites.net/api")\nSIIGO_FUNCTION_KEY = os.getenv("SIIGO_FUNCTION_KEY", "")\n\n\n# ==================== HELPER ====================\n\ndef _call_siigo(endpoint: str, operacion: str, method: str = "GET",\n                query_params: dict = None, body: dict = None) -> str:\n    """\n    Llama a una Azure Function de SIIGO CRUD.\n    \n    Args:\n        endpoint: Nombre del endpoint (ej: "clientes", "productos")\n        operacion: Operación a realizar (ej: "listar", "crear")\n        method: Método HTTP (GET, POST, PUT, DELETE)\n        query_params: Parámetros de consulta adicionales\n        body: Cuerpo JSON para POST/PUT\n    \n    Returns:\n        Respuesta JSON como string\n    """\n    url = f"{SIIGO_BASE_URL}/{endpoint}"\n    \n    params = {\n        "code": SIIGO_FUNCTION_KEY,\n        "operacion": operacion,\n    }\n    \n    if query_params:\n        params.update(query_params)\n    \n    try:\n        headers = {"Content-Type": "application/json"} if body else {}\n        \n        if method == "GET":\n            resp = requests.get(url, params=params, timeout=30)\n        elif method == "POST":\n            resp = requests.post(url, params=params, json=body, headers=headers, timeout=30)\n        elif method == "PUT":\n            resp = requests.put(url, params=params, json=body, headers=headers, timeout=30)\n        elif method == "DELETE":\n            resp = requests.delete(url, params=params, timeout=30)\n        else:\n            return json.dumps({"error": f"Método HTTP no soportado: {method}"})\n        \n        # Intentar parsear la respuesta como JSON\n        try:\n            data = resp.json()\n        except Exception:\n            data = {"raw_response": resp.text, "status_code": resp.status_code}\n        \n        # Limitar el tamaño de la respuesta para no saturar al LLM\n        response_str = json.dumps(data, ensure_ascii=False, indent=2)\n        if len(response_str) > 8000:\n            response_str = response_str[:8000] + "\n... (respuesta truncada por tamaño)"\n        \n        return response_str\n        \n    except requests.exceptions.Timeout:\n        return json.dumps({"error": "Timeout: La solicitud tardó demasiado"})\n    except requests.exceptions.ConnectionError:\n        return json.dumps({"error": "Error de conexión con el servidor de SIIGO"})\n    except Exception as e:\n        return json.dumps({"error": f"Error inesperado: {str(e)}"})\n\n\ndef _detect_method(operacion: str) -> str:\n    """Detecta el método HTTP según el nombre de la operación."""\n    operacion_lower = operacion.lower()\n    if operacion_lower in ("crear", "crear_anticipo", "enviar_mail"):\n        return "POST"\n    elif operacion_lower in ("editar",):\n        return "PUT"\n    elif operacion_lower in ("eliminar", "anular"):\n        return "DELETE"\n    else:\n        return "GET"\n\n\ndef _parse_parametros(parametros_json: str) -> dict:\n    """Parsea un string JSON a dict, con manejo de errores."""\n    if not parametros_json or parametros_json.strip() in ("", "{}", "null", "none"):\n        return {}\n    try:\n        return json.loads(parametros_json)\n    except json.JSONDecodeError:\n        return {}\n\n\ndef _execute_siigo_tool(endpoint: str, operacion: str, parametros_json: str) -> str:\n    """\n    Ejecuta una operación SIIGO determinando automáticamente el método HTTP\n    y separando parámetros de query vs body.\n    """\n    method = _detect_method(operacion)\n    params = _parse_parametros(parametros_json)\n    \n    if method in ("POST", "PUT"):\n        # Para POST/PUT: extraer parámetros de query del body\n        query_params = {}\n        body = params.copy()\n        \n        # Estos campos van como query params, no en el body\n        for key in ["id", "nombre", "identificacion", "codigo", "nombre_factura"]:\n            if key in body:\n                query_params[key] = body.pop(key)\n        \n        return _call_siigo(endpoint, operacion, method, query_params=query_params, body=body)\n    elif method == "DELETE":\n        return _call_siigo(endpoint, operacion, method, query_params=params)\n    else:  # GET\n        return _call_siigo(endpoint, operacion, method, query_params=params)\n\n\n# ==================== TOOLS ====================\n\n# 1. CATÁLOGOS\ndef siigo_catalogos(\n    catalogo: Annotated[str, "Catálogo a consultar: 'impuestos', 'listas_precio', 'bodegas', 'usuarios', 'tipos_comprobante', 'formas_pago', 'centros_costo', 'activos_fijos', 'grupos_inventario', 'cuentas_contables', 'monedas', 'todos'"],\n    parametros: Annotated[str, "JSON con parámetros adicionales opcionales. Ej: {\"tipo\": \"FV\"} para tipos_comprobante, {\"tipo_documento\": \"FV\"} para formas_pago. Dejar '{}' si no aplica."] = "{}",\n) -> str:\n    """Consulta catálogos y listas maestras de Siigo Nube: impuestos, bodegas, usuarios, formas de pago, centros de costo, cuentas contables, etc. Solo lectura."""\n    params = _parse_parametros(parametros)\n    params["catalogo"] = catalogo\n    return _call_siigo("catalogos", catalogo, "GET", query_params=params)\n\n\n# 2. CLIENTES\ndef siigo_clientes(\n    operacion: Annotated[str, "Operación a realizar: GET → 'consultar_por_id' (id), 'consultar_por_identificacion' (identificacion), 'listar' (filtros opcionales), 'tipos_documento', 'responsabilidades_fiscales', 'usuarios'. POST → 'crear' (body JSON). PUT → 'editar' (id o identificacion + body JSON). NOTA: Los clientes NO se pueden eliminar en Siigo."],\n    parametros: Annotated[str, "JSON con parámetros. GET: {\"id\": \"xxx\"} o {\"identificacion\": \"123\"} o {\"page\": \"1\", \"page_size\": \"25\"}. POST crear: JSON completo del cliente (person_type, id_type, identification, name[], etc.). PUT editar: {\"id\": \"xxx\", ...campos a editar}. Dejar '{}' si no aplica."] = "{}",\n) -> str:\n    """Gestiona clientes/terceros en Siigo Nube. Crear, consultar, listar y editar clientes. Los clientes NO se pueden eliminar según la API de Siigo."""\n    return _execute_siigo_tool("clientes", operacion, parametros)\n\n\n# 3. PRODUCTOS\ndef siigo_productos(\n    operacion: Annotated[str, "Operación: GET → 'consultar_por_id' (id), 'consultar_por_codigo' (codigo), 'listar' (filtros), 'grupos_inventario', 'impuestos', 'bodegas'. POST → 'crear' (body JSON). PUT → 'editar' (id o codigo + body). DELETE → 'eliminar' (id o codigo)."],\n    parametros: Annotated[str, "JSON con parámetros. GET: {\"id\": \"xxx\"} o {\"codigo\": \"PROD001\"}. POST crear: JSON del producto (code, name, account_group, etc.). PUT editar: {\"id\": \"xxx\", ...}. DELETE: {\"id\": \"xxx\"} o {\"codigo\": \"PROD001\"}. Dejar '{}' si no aplica."] = "{}",\n) -> str:\n    """Gestiona productos y servicios en Siigo Nube. CRUD completo: crear, consultar, listar, editar y eliminar productos."""\n    return _execute_siigo_tool("productos", operacion, parametros)\n\n\n# 4. FACTURAS DE VENTA\ndef siigo_facturas_venta(\n    operacion: Annotated[str, "Operación: GET → 'consultar_por_id' (id), 'consultar_por_nombre' (nombre, ej: FV-003-457), 'listar' (filtros), 'tipos_factura', 'vendedores', 'impuestos', 'formas_pago', 'productos', 'clientes', 'pdf' (id), 'xml' (id), 'errores_dian' (id). POST → 'crear' (body JSON), 'enviar_mail' (id + body emails). PUT → 'editar' (id o nombre + body). DELETE → 'eliminar' (id o nombre), 'anular' (id o nombre)."],\n    parametros: Annotated[str, "JSON con parámetros. GET: {\"id\": \"xxx\"} o {\"nombre\": \"FV-003-457\"} o {\"date_start\": \"2024-01-01\", \"date_end\": \"2024-12-31\"}. POST crear: JSON de factura (document, date, customer, seller, items[], payments[], stamp). DELETE: {\"id\": \"xxx\"} o {\"nombre\": \"FV-xxx\"}. Dejar '{}' si no aplica."] = "{}",\n) -> str:\n    """Gestiona facturas de venta en Siigo Nube. CRUD completo + facturación electrónica DIAN: crear, consultar, listar, editar, eliminar, anular, obtener PDF/XML, enviar por email."""\n    return _execute_siigo_tool("facturas_venta", operacion, parametros)\n\n\n# 5. FACTURAS DE COMPRA\ndef siigo_facturas_compra(\n    operacion: Annotated[str, "Operación: GET → 'consultar_por_id' (id), 'consultar_por_nombre' (nombre, ej: FC-1-22), 'listar' (filtros), 'tipos_facturas', 'formas_pago', 'impuestos'. POST → 'crear' (body JSON). PUT → 'editar' (body + id). DELETE → 'eliminar' (id)."],\n    parametros: Annotated[str, "JSON con parámetros. GET: {\"id\": \"xxx\"} o {\"nombre\": \"FC-1-22\"}. POST crear: JSON de factura de compra. PUT editar: {\"id\": \"xxx\", ...}. DELETE: {\"id\": \"xxx\"}. Dejar '{}' si no aplica."] = "{}",\n) -> str:\n    """Gestiona facturas de compra/gasto en Siigo Nube. CRUD completo: crear, consultar, listar, editar y eliminar facturas de compra."""\n    return _execute_siigo_tool("facturas_compra", operacion, parametros)\n\n\n# 6. NOTAS CRÉDITO\ndef siigo_notas_credito(\n    operacion: Annotated[str, "Operación: GET → 'consultar_por_id' (id), 'consultar_por_nombre' (nombre, ej: NC-001-123), 'listar' (filtros), 'tipos_nota_credito', 'vendedores', 'impuestos', 'formas_pago', 'productos', 'facturas', 'buscar_factura' (nombre_factura), 'pdf' (id). POST → 'crear' (body JSON). NOTA: No se pueden editar ni eliminar notas crédito en Siigo."],\n    parametros: Annotated[str, "JSON con parámetros. GET: {\"id\": \"xxx\"} o {\"nombre\": \"NC-001-123\"} o {\"nombre_factura\": \"FV-003-457\"}. POST crear: JSON de nota crédito (document, date, invoice, reason, items[], payments[], stamp). Dejar '{}' si no aplica."] = "{}",\n) -> str:\n    """Gestiona notas crédito en Siigo Nube. Solo crear y consultar (la API de Siigo NO permite editar ni eliminar notas crédito)."""\n    return _execute_siigo_tool("notas_credito", operacion, parametros)\n\n\n# 7. COTIZACIONES\ndef siigo_cotizaciones(\n    operacion: Annotated[str, "Operación: GET → 'consultar_por_id' (id), 'consultar_por_nombre' (nombre, ej: C-003-457), 'listar' (filtros), 'tipos_cotizacion', 'vendedores', 'impuestos'. POST → 'crear' (body JSON). PUT → 'editar' (id o nombre + body). DELETE → 'eliminar' (id o nombre)."],\n    parametros: Annotated[str, "JSON con parámetros. GET: {\"id\": \"xxx\"} o {\"nombre\": \"C-003-457\"}. POST crear: JSON de cotización (document, date, customer, seller, items[]). PUT editar: {\"id\": \"xxx\", ...}. DELETE: {\"id\": \"xxx\"}. Dejar '{}' si no aplica."] = "{}",\n) -> str:\n    """Gestiona cotizaciones/ofertas comerciales en Siigo Nube. CRUD completo: crear, consultar, listar, editar y eliminar cotizaciones."""\n    return _execute_siigo_tool("cotizaciones", operacion, parametros)\n\n\n# 8. RECIBOS DE CAJA\ndef siigo_recibos_caja(\n    operacion: Annotated[str, "Operación: GET → 'consultar_por_id' (id), 'consultar_por_nombre' (nombre, ej: RC-1-22), 'listar' (filtros), 'tipos_recibos', 'formas_pago'. POST → 'crear' (body JSON), 'crear_anticipo' (body JSON). NOTA: No se pueden editar ni eliminar recibos de caja."],\n    parametros: Annotated[str, "JSON con parámetros. GET: {\"id\": \"xxx\"} o {\"nombre\": \"RC-1-22\"}. POST crear/crear_anticipo: JSON del recibo. Dejar '{}' si no aplica."] = "{}",\n) -> str:\n    """Gestiona recibos de caja/ingresos en Siigo Nube. Solo crear y consultar (la API de Siigo NO permite editar ni eliminar recibos de caja)."""\n    return _execute_siigo_tool("recibos_caja", operacion, parametros)\n\n\n# 9. RECIBOS DE PAGO\ndef siigo_recibos_pago(\n    operacion: Annotated[str, "Operación: GET → 'consultar_por_id' (id), 'consultar_por_nombre' (nombre, ej: RP-1-22), 'listar' (filtros), 'tipos_recibos', 'formas_pago'. POST → 'crear' (body JSON). DELETE → 'eliminar' (id)."],\n    parametros: Annotated[str, "JSON con parámetros. GET: {\"id\": \"xxx\"} o {\"nombre\": \"RP-1-22\"}. POST crear: JSON del recibo de pago. DELETE: {\"id\": \"xxx\"}. Dejar '{}' si no aplica."] = "{}",\n) -> str:\n    """Gestiona recibos de pago/egresos en Siigo Nube. Crear, consultar, listar y eliminar recibos de pago a proveedores."""\n    return _execute_siigo_tool("recibos_pago", operacion, parametros)\n\n\n# 10. COMPROBANTES CONTABLES\ndef siigo_comprobantes_contables(\n    operacion: Annotated[str, "Operación: GET → 'consultar_por_id' (id), 'consultar_por_nombre' (nombre, ej: CC-1-22), 'listar' (filtros), 'tipos_comprobantes', 'cuentas_contables', 'impuestos', 'centros_costo'. POST → 'crear' (body JSON). NOTA: No se pueden editar ni eliminar comprobantes contables."],\n    parametros: Annotated[str, "JSON con parámetros. GET: {\"id\": \"xxx\"} o {\"nombre\": \"CC-1-22\"}. POST crear: JSON del comprobante contable (document, date, items[] con account, customer, description, etc.). Dejar '{}' si no aplica."] = "{}",\n) -> str:\n    """Gestiona comprobantes contables en Siigo Nube. Solo crear y consultar (la API de Siigo NO permite editar ni eliminar comprobantes contables)."""\n    return _execute_siigo_tool("comprobantes_contables", operacion, parametros)\n\n\n# 11. CUENTAS POR PAGAR\ndef siigo_cuentas_por_pagar(\n    operacion: Annotated[str, "Operación (solo consulta): 'listar' (filtros opcionales), 'por_proveedor' (identificacion), 'por_fecha' (fecha_inicio, fecha_fin), 'vencidas' (fecha_corte opcional), 'resumen'."],\n    parametros: Annotated[str, "JSON con parámetros. {\"identificacion\": \"xxx\", \"sucursal\": \"0\"} para por_proveedor. {\"fecha_inicio\": \"2024-01-01\", \"fecha_fin\": \"2024-12-31\"} para por_fecha. {\"fecha_corte\": \"2024-06-01\"} para vencidas. Dejar '{}' si no aplica."] = "{}",\n) -> str:\n    """Consulta cuentas por pagar en Siigo Nube. Solo lectura: listar, buscar por proveedor, por fecha, vencidas, y resumen general."""\n    return _execute_siigo_tool("cuentas_por_pagar", operacion, parametros)\n\n\n# 12. CATEGORÍAS DE INVENTARIO\ndef siigo_categorias_inventario(\n    operacion: Annotated[str, "Operación: GET → 'listar', 'consultar_por_nombre' (nombre), 'consultar_por_codigo' (codigo). POST → 'crear' (body JSON). PUT → 'editar' (id o codigo + body). NOTA: No se pueden eliminar categorías de inventario."],\n    parametros: Annotated[str, "JSON con parámetros. GET: {\"nombre\": \"xxx\"} o {\"codigo\": \"xxx\"}. POST crear: JSON de la categoría. PUT editar: {\"id\": \"xxx\", ...} o {\"codigo\": \"xxx\", ...}. Dejar '{}' si no aplica."] = "{}",\n) -> str:\n    """Gestiona categorías/clasificaciones de inventario en Siigo Nube. Crear, consultar, listar y editar categorías. No se pueden eliminar."""\n    return _execute_siigo_tool("categorias_inventario", operacion, parametros)\n\n\n# ==================== LISTA DE TOOLS SIIGO ====================\n\nSIIGO_TOOLS = [\n    siigo_catalogos,\n    siigo_clientes,\n    siigo_productos,\n    siigo_facturas_venta,\n    siigo_facturas_compra,\n    siigo_notas_credito,\n    siigo_cotizaciones,\n    siigo_recibos_caja,\n    siigo_recibos_pago,\n    siigo_comprobantes_contables,\n    siigo_cuentas_por_pagar,\n    siigo_categorias_inventario,\n]\n