"""\nSub-Agente SIIGO: agente especializado en operaciones CRUD del ERP Siigo Nube.\nEl agente principal le delega todas las consultas relacionadas con Siigo.\n"""\nimport os\nfrom agent_framework import ChatAgent\nfrom agent_framework.openai import OpenAIChatClient\nfrom siigo_tools import SIIGO_TOOLS\n\n\n# Instancia global del sub-agente SIIGO\n_siigo_agent = None\n_siigo_thread = None\n\n\nasync def _get_siigo_agent() -> ChatAgent:\n    """Crea o retorna el sub-agente SIIGO (singleton)."""\n    global _siigo_agent\n    \n    if _siigo_agent is not None:\n        return _siigo_agent\n    \n    openai_api_key = os.getenv("OPENAI_API_KEY")\n    model_id = os.getenv("MODEL_ID", "gpt-4o-mini")\n    \n    if not openai_api_key:\n        raise ValueError("OPENAI_API_KEY no est\u00e1 configurado.")\n    \n    client = OpenAIChatClient(\n        api_key=openai_api_key,\n        model_id=model_id,\n    )\n    \n    _siigo_agent = ChatAgent(\n        name="SubAgenteSIIGO",\n        instructions="""Eres un sub-agente especializado en el ERP Siigo Nube.\nTu \u00daNICA responsabilidad es ejecutar operaciones CRUD sobre Siigo Nube usando tus herramientas.\n\n## M\u00f3dulos disponibles\n1. **Cat\u00e1logos** (siigo_catalogos): Impuestos, bodegas, usuarios, formas de pago, centros de costo, cuentas contables, monedas, etc.\n2. **Clientes** (siigo_clientes): Crear, consultar, listar, editar. NO se pueden eliminar.\n3. **Productos** (siigo_productos): CRUD completo de productos y servicios.\n4. **Facturas de Venta** (siigo_facturas_venta): CRUD + facturaci\u00f3n electr\u00f3nica DIAN (PDF, XML, email).\n5. **Facturas de Compra** (siigo_facturas_compra): CRUD completo.\n6. **Notas Cr\u00e9dito** (siigo_notas_credito): Solo crear y consultar. NO editar/eliminar.\n7. **Cotizaciones** (siigo_cotizaciones): CRUD completo.\n8. **Recibos de Caja** (siigo_recibos_caja): Solo crear y consultar. NO editar/eliminar.\n9. **Recibos de Pago** (siigo_recibos_pago): Crear, consultar, eliminar.\n10. **Comprobantes Contables** (siigo_comprobantes_contables): Solo crear y consultar.\n11. **Cuentas por Pagar** (siigo_cuentas_por_pagar): Solo consulta (reportes).\n12. **Categor\u00edas de Inventario** (siigo_categorias_inventario): Crear, consultar, editar. NO eliminar.\n\n## Reglas\n- Ejecuta la operaci\u00f3n solicitada usando la herramienta correcta.\n- Los par\u00e1metros JSON deben ser un string JSON v\u00e1lido.\n- Si necesitas datos que no te dieron, ind\u00edcalo claramente.\n- Devuelve los resultados de forma clara y estructurada.\n- Para operaciones destructivas (eliminar, anular), confirma antes de ejecutar.\n- Responde siempre en espa\u00f1ol.""",\n        chat_client=client,\n        tools=SIIGO_TOOLS,\n    )\n    \n    return _siigo_agent\n\n\nasync def run_siigo_agent(query: str) -> str:\n    """\n    Ejecuta el sub-agente SIIGO con una consulta y retorna la respuesta.\n    Usa un thread dedicado para mantener contexto entre llamadas.\n    """\n    global _siigo_thread\n    \n    agent = await _get_siigo_agent()\n    \n    if _siigo_thread is None:\n        _siigo_thread = agent.get_new_thread()\n    \n    response_text = ""\n    async for chunk in agent.run_stream(query, thread=_siigo_thread):\n        if chunk.text:\n            response_text += chunk.text\n    \n    return response_text\n\n\ndef reset_siigo_agent():\n    """Resetea el sub-agente (para limpiar estado)."""\n    global _siigo_agent, _siigo_thread\n    _siigo_agent = None\n    _siigo_thread = None\n